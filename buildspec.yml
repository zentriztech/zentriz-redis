version: 0.2

env:
  variables:
    NODE_VERSION: "20"
    PACKAGE_NAME: "redis"
    LAYER_NAME: "zentriz-redis-layer"
    AWS_DEFAULT_REGION: "us-east-1"

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "üöÄ Iniciando build do @zentriztech/redis"
      - echo "Node:" && node --version
      - echo "NPM:" && npm --version

      # pnpm
      - npm install -g pnpm@latest
      - echo "PNPM:" && pnpm --version

      # jq + zip (garante via apt, se faltar)
      - jq --version >/dev/null 2>&1 || (apt-get update && apt-get install -y jq)
      - zip -v >/dev/null 2>&1 || (echo "zip n√£o encontrado; instalando..." && (apt-get update && apt-get install -y zip) || true)

      # AWS CLI + identidade
      - aws --version || { echo "‚ùå AWS CLI ausente"; exit 1; }
      - aws sts get-caller-identity || { echo "‚ùå Falha ao obter identidade AWS (credenciais?)"; exit 1; }
      - export AWS_PAGER=""

  pre_build:
    commands:
      - echo "üì¶ Instalando depend√™ncias..."
      - pnpm install --no-frozen-lockfile || { echo "‚ùå Falha ao instalar deps"; exit 1; }

      - echo "üßπ Limpando build anterior..."
      - pnpm run clean || true

  build:
    commands:
      - |
        set -euo pipefail

        echo "üî® Compilando TypeScript..."
        pnpm run build

        echo "üß™ Validando build..."
        test -d dist || { echo "‚ùå Pasta dist n√£o encontrada"; exit 1; }
        [ -s package.json ] || { echo "‚ùå package.json vazio/ausente"; exit 1; }

        echo "üìã Lendo metadados do package.json (repo)..."
        PKG_NAME=$(jq -r '.name' package.json)
        CURRENT_VERSION=$(jq -r '.version' package.json)
        [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.+)?$ ]] || {
          echo "‚ùå Vers√£o inv√°lida: $CURRENT_VERSION (esperado semver)"; exit 1;
        }
        echo "Pacote: $PKG_NAME; Vers√£o (repo): $CURRENT_VERSION"

        echo "=== IN√çCIO DA VERIFICA√á√ÉO DE VERS√ÉO (comparar package.json da layer x repo) ==="
        LAST_LAYER_VERSION=$(aws lambda list-layer-versions \
          --layer-name "$LAYER_NAME" \
          --region "$AWS_DEFAULT_REGION" \
          --max-items 1 \
          --query 'LayerVersions[0].Version' \
          --output text 2>/dev/null || echo "None")

        echo "√öltima vers√£o da layer: $LAST_LAYER_VERSION"

        CREATE_LAYER=false
        if [ "$LAST_LAYER_VERSION" = "None" ] || [ "$LAST_LAYER_VERSION" = "null" ] || [ -z "$LAST_LAYER_VERSION" ]; then
          echo "üÜï Nenhuma vers√£o da layer encontrada. Precisamos criar."
          CREATE_LAYER=true
        else
          DOWNLOAD_URL=$(
            aws lambda get-layer-version \
              --layer-name "$LAYER_NAME" \
              --version-number "$LAST_LAYER_VERSION" \
              --region "$AWS_DEFAULT_REGION" \
              --query 'Content.Location' \
              --output text 2>&1 || true
          )

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "None" ] || [[ "$DOWNLOAD_URL" == *"AccessDenied"* ]] || [[ "$DOWNLOAD_URL" == *"error"* ]]; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            LAYER_ARN="arn:aws:lambda:${AWS_DEFAULT_REGION}:${ACCOUNT_ID}:layer:${LAYER_NAME}:${LAST_LAYER_VERSION}"
            echo "Tentando fallback por ARN: $LAYER_ARN"
            DOWNLOAD_URL=$(
              aws lambda get-layer-version-by-arn \
                --arn "$LAYER_ARN" \
                --region "$AWS_DEFAULT_REGION" \
                --query 'Content.Location' \
                --output text 2>&1 || true
            )
          fi

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "None" ] || [[ "$DOWNLOAD_URL" == *"AccessDenied"* ]] || [[ "$DOWNLOAD_URL" == *"error"* ]]; then
            echo "‚ö†Ô∏è N√£o foi poss√≠vel obter a URL do conte√∫do da layer (sem permiss√£o/erro)."
            echo "üîí Padr√£o seguro aplicado: N√ÉO publicar nova vers√£o. (CREATE_LAYER=false)"
            CREATE_LAYER=false
          else
            echo "‚¨áÔ∏è Baixando conte√∫do da layer para ler package.json interno..."
            wget -q "$DOWNLOAD_URL" -O current-layer.zip || {
              echo "‚ö†Ô∏è Falha no download da layer. Padr√£o seguro: N√ÉO publicar."; CREATE_LAYER=false;
            }

            if [ -f current-layer.zip ]; then
              mkdir -p current-layer-temp
              set +e
              unzip -q current-layer.zip -d current-layer-temp
              UNZIP_STATUS=$?
              set -e
              if [ $UNZIP_STATUS -ne 0 ]; then
                echo "‚ö†Ô∏è Aviso ao extrair layer (status $UNZIP_STATUS)."
              fi

              LAYER_PKG_JSON="current-layer-temp/nodejs/node_modules/@zentriztech/redis/package.json"
              if [ -s "$LAYER_PKG_JSON" ]; then
                LAYER_PACKAGE_VERSION=$(jq -r '.version' "$LAYER_PKG_JSON" 2>/dev/null || echo "")
                echo "Vers√£o (layer): ${LAYER_PACKAGE_VERSION:-<n√£o encontrada>}"

                if [ -n "$LAYER_PACKAGE_VERSION" ] && [ "$LAYER_PACKAGE_VERSION" = "$CURRENT_VERSION" ]; then
                  echo "‚úÖ Vers√µes IGUAIS. N√ÉO publicar. (CREATE_LAYER=false)"
                  CREATE_LAYER=false
                else
                  echo "üîÑ Vers√µes DIFERENTES (layer: ${LAYER_PACKAGE_VERSION:-n/d} vs repo: $CURRENT_VERSION). Publicar."
                  CREATE_LAYER=true
                fi
              else
                echo "‚ö†Ô∏è package.json interno n√£o encontrado na layer. Padr√£o seguro: N√ÉO publicar."
                CREATE_LAYER=false
              fi

              rm -rf current-layer.zip current-layer-temp
            fi
          fi
        fi

        : "${BASH_ENV:=/tmp/codebuild.bash_env}"
        touch "$BASH_ENV" || { echo "‚ùå N√£o consegui criar $BASH_ENV"; exit 1; }
        echo "export CREATE_LAYER=${CREATE_LAYER:-false}" >> "$BASH_ENV"
        echo "=== FIM DA VERIFICA√á√ÉO ‚Äî CREATE_LAYER=${CREATE_LAYER:-false} ==="

      # Empacotar/publicar S√ì se CREATE_LAYER=true
      - |
        set -euo pipefail
        if [ "${CREATE_LAYER:-false}" = "false" ]; then
          echo "üü¢ Skip confirmado: vers√µes iguais ou sem possibilidade de validar com seguran√ßa. N√£o publicaremos."
        else
          echo "üöÄ Empacotando Lambda Layer..."
          mkdir -p nodejs
          pushd nodejs >/dev/null

          echo '{"name":"zentriz-redis-layer","version":"1.0.0","dependencies":{}}' > package.json
          jq --argjson deps "$(jq -c '.dependencies // {}' ../package.json)" '.dependencies = $deps' package.json > package.json.tmp && mv package.json.tmp package.json

          echo "üì¶ Instalando depend√™ncias de produ√ß√£o..."
          npm install --production --no-package-lock || { echo "‚ùå Falha no npm install da layer"; exit 1; }

          rm -f package.json
          popd >/dev/null

          mkdir -p nodejs/node_modules/@zentriztech/redis
          cp -r dist/* nodejs/node_modules/@zentriztech/redis/
          cp package.json nodejs/node_modules/@zentriztech/redis/

          # Incluir depend√™ncias @zentriztech/* (core)
          if [ -d "../core/dist" ]; then
            echo "üì¶ Incluindo depend√™ncia @zentriztech/core..."
            mkdir -p nodejs/node_modules/@zentriztech/core
            cp -r ../core/dist/* nodejs/node_modules/@zentriztech/core/
            cp ../core/package.json nodejs/node_modules/@zentriztech/core/
          fi

          echo "üì¶ Criando ZIP da layer..."
          zip -qr zentriz-redis-layer.zip nodejs
          test -s zentriz-redis-layer.zip || { echo "‚ùå ZIP n√£o gerado"; exit 1; }
          ls -lh zentriz-redis-layer.zip

          echo "üì§ Publicando Lambda Layer (com retries)..."
          ATTEMPTS=0
          until [ $ATTEMPTS -ge 3 ]
          do
            set +e
            aws lambda publish-layer-version \
              --layer-name "${LAYER_NAME}" \
              --description "Zentriz Redis Package v$(jq -r '.version' package.json) ‚Äî built $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --zip-file fileb://zentriz-redis-layer.zip \
              --compatible-runtimes nodejs20.x \
              --region "${AWS_DEFAULT_REGION}"
            STATUS=$?
            set -e
            if [ $STATUS -eq 0 ]; then
              echo "‚úÖ Publica√ß√£o conclu√≠da."
              break
            fi
            ATTEMPTS=$((ATTEMPTS+1))
            echo "‚ö†Ô∏è Falha ao publicar (tentativa ${ATTEMPTS}/3). Aguardando e tentando de novo..."
            sleep $((ATTEMPTS * 5))
          done

          if [ $STATUS -ne 0 ]; then
            echo "‚ùå Falha ao publicar a layer ap√≥s 3 tentativas."
          fi
        fi

  post_build:
    commands:
      - echo "üéâ Build finalizado."
      - rm -f layer-flag.txt || true

artifacts:
  files:
    - dist/**/*
    - package.json
  name: zentriz-redis-build-$(date +%Y-%m-%d-%H-%M-%S)

cache:
  paths:
    - node_modules/**/*
    - ~/.pnpm-store/**/*
